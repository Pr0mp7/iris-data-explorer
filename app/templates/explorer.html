{% extends "base.html" %}
{% block title %}Case #{{ case_id }} â€” IRIS Data Explorer{% endblock %}

{% block nav_extra %}
<a href="/" class="btn btn-sm btn-outline-secondary">All Cases</a>
{% endblock %}

{% block content %}
{# Case header #}
{% set cs = data.case %}
<div class="case-header mb-3 p-3 rounded border">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h4 class="mb-1">
                <span class="badge bg-secondary me-2">#{{ case_id }}</span>
                {{ cs.case_name if cs.case_name is defined else cs.get('case_name', cs.get('name', 'Unknown')) }}
            </h4>
            <p class="text-body-secondary mb-0">
                {{ cs.case_description if cs.case_description is defined else cs.get('case_description', cs.get('description', '')) }}
            </p>
        </div>
        <div class="text-end text-nowrap">
            <small class="text-body-secondary d-block">
                SOC ID: {{ cs.case_soc_id if cs.case_soc_id is defined else cs.get('case_soc_id', cs.get('soc_id', 'N/A')) }}
            </small>
            <small class="text-body-secondary d-block">
                Opened: {{ cs.case_open_date if cs.case_open_date is defined else cs.get('case_open_date', cs.get('open_date', 'N/A')) }}
            </small>
        </div>
    </div>
</div>

{# Entity counts #}
<div class="row g-2 mb-3">
    {% set entities = [
        ('assets', 'Assets', 'bg-primary'),
        ('iocs', 'IOCs', 'bg-danger'),
        ('events', 'Timeline', 'bg-info'),
        ('tasks', 'Tasks', 'bg-warning'),
        ('notes', 'Notes', 'bg-success'),
        ('evidences', 'Evidence', 'bg-secondary')
    ] %}
    {% for key, label, color in entities %}
    <div class="col-auto">
        <span class="badge {{ color }} fs-6 entity-badge" data-tab="{{ key }}" role="button">
            {{ label }}
            <span class="badge bg-light text-dark ms-1">{{ data[key]|length if data[key] is iterable and data[key] is not string else 0 }}</span>
        </span>
    </div>
    {% endfor %}
</div>

{# Tabs #}
<ul class="nav nav-tabs" id="entityTabs" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-assets" type="button">Assets</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-iocs" type="button">IOCs</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-events" type="button">Timeline</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-tasks" type="button">Tasks</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-notes" type="button">Notes</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-evidences" type="button">Evidence</button>
    </li>
</ul>

<div class="tab-content pt-3" id="entityTabContent">
    {# Assets #}
    <div class="tab-pane fade show active" id="tab-assets">
        <table id="dt-assets" class="table table-striped table-hover" style="width:100%">
            <thead><tr>
                <th>ID</th><th>Name</th><th>IP</th><th>Domain</th>
                <th>Type</th><th>Compromise</th><th>Description</th><th>Added</th>
            </tr></thead>
            <tbody></tbody>
        </table>
    </div>

    {# IOCs #}
    <div class="tab-pane fade" id="tab-iocs">
        <table id="dt-iocs" class="table table-striped table-hover" style="width:100%">
            <thead><tr>
                <th>ID</th><th>Value</th><th>Type</th><th>TLP</th>
                <th>Tags</th><th>Description</th>
            </tr></thead>
            <tbody></tbody>
        </table>
    </div>

    {# Events (Timeline) #}
    <div class="tab-pane fade" id="tab-events">
        <table id="dt-events" class="table table-striped table-hover" style="width:100%">
            <thead><tr>
                <th>ID</th><th>Date</th><th>Title</th><th>Source</th>
                <th>Tags</th><th>Content</th>
            </tr></thead>
            <tbody></tbody>
        </table>
    </div>

    {# Tasks #}
    <div class="tab-pane fade" id="tab-tasks">
        <table id="dt-tasks" class="table table-striped table-hover" style="width:100%">
            <thead><tr>
                <th>ID</th><th>Title</th><th>Status</th><th>Tags</th>
                <th>Opened</th><th>Closed</th><th>Description</th>
            </tr></thead>
            <tbody></tbody>
        </table>
    </div>

    {# Notes #}
    <div class="tab-pane fade" id="tab-notes">
        <table id="dt-notes" class="table table-striped table-hover" style="width:100%">
            <thead><tr>
                <th>ID</th><th>Title</th><th>Created</th><th>Updated</th><th>Content</th>
            </tr></thead>
            <tbody></tbody>
        </table>
    </div>

    {# Evidences #}
    <div class="tab-pane fade" id="tab-evidences">
        <table id="dt-evidences" class="table table-striped table-hover" style="width:100%">
            <thead><tr>
                <th>ID</th><th>Filename</th><th>Hash</th><th>Size</th>
                <th>Added</th><th>Description</th>
            </tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var CASE_DATA = {{ data | tojson }};
</script>
{% endblock %}
